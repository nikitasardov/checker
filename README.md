# Site Availability Checker

Сервис на Python 3.12 для проверки доступности сайтов и отдельных страниц по HTTP/HTTPS.
Запускается через Docker Compose, читает список объектов из `config.json`, пишет логи во внешний каталог и отправляет уведомления в Telegram.

## Возможности

- Проверка нескольких URL из конфигурации.
- Критерий доступности: только HTTP `200`.
- Периодические проверки (по умолчанию раз в 60 секунд).
- Индивидуальные настройки для каждого объекта:
  - `timeout_seconds`
  - `failure_threshold`
  - `enabled`
- Антиспам-логика уведомлений:
  - одно сообщение при переходе `UP -> DOWN`
  - без повторов, пока объект остается недоступным
  - одно сообщение при переходе `DOWN -> UP`

## Структура проекта

- `app/main.py` — точка входа и цикл проверок.
- `app/checker.py` — проверка URL и логика состояний объектов.
- `app/notifier.py` — отправка уведомлений в Telegram.
- `app/config.py` — загрузка и валидация `config.json`.
- `docker-compose.yml` — запуск контейнера.
- `Dockerfile` — образ `python:3.12-alpine`.
- `config.example.json` — пример конфигурации без секретов.

## Конфигурация

1. Скопируйте пример:

```bash
cp config.example.json config.json
```

2. Заполните в `config.json`:

- `checker_name` — опциональное имя сервера/инстанса мониторинга (например, `prod-ru-1`), добавляется в Telegram-уведомления.
- `telegram.bot_token` — токен Telegram-бота.
- `telegram.chat_id` — ID чата для уведомлений.
- `global_defaults.interval_seconds` — интервал проверки в секундах, по умолчанию `60`.
- `global_defaults.timeout_seconds` — таймаут HTTP-запроса в секундах, по умолчанию `5`.
- `global_defaults.failure_threshold` — число подряд неудачных проверок до состояния DOWN, по умолчанию `1`.
- `targets` — массив проверяемых объектов.

Поля объекта в `targets`:

- `name` — имя объекта для логов и уведомлений.
- `url` — URL (`http` или `https`).
- `enabled` — включить/выключить объект.
- `timeout_seconds` — override таймаута для конкретного объекта.
- `failure_threshold` — override порога неудачных проверок для конкретного объекта.

Пример объекта:

```json
{
  "name": "Main website",
  "url": "https://example.com",
  "enabled": true,
  "timeout_seconds": 5,
  "failure_threshold": 2
}
```

## Запуск

Сборка и запуск:

```bash
docker compose up --build -d
```

Просмотр статуса:

```bash
docker compose ps
```

Просмотр логов контейнера:

```bash
docker compose logs -f site-checker
```

Остановка:

```bash
docker compose down
```

## Где хранятся конфиг и логи

- Конфиг хранится на хосте: `./config.json` и монтируется в контейнер как `/app/config.json` (read-only).
- Логи пишутся в контейнере в `/logs/site-checker.log` и сохраняются на хосте в `./logs/site-checker.log`.
- Ротация логов выполняется ежедневно: архивные файлы создаются с датой в имени (`site-checker-YYYY-MM-DD.log`).
- Хранится до 30 дневных файлов, старые удаляются автоматически.

## Как работает расписание

- За один цикл сервис проверяет все `enabled`-объекты.
- После завершения цикла ожидает `interval_seconds` с учетом уже потраченного времени на проверки.
- Если проверки заняли дольше интервала, следующий цикл стартует сразу.
- `config.json` перечитывается перед каждым циклом проверки, поэтому изменения списка объектов, порогов и таймаутов применяются без перезапуска сервиса.
- Изменения Telegram-параметров и `checker_name` также подхватываются без перезапуска.
- Если в `config.json` ошибка, сервис продолжает работу на последней валидной конфигурации и пишет ошибку в лог.

## Формат уведомлений

- В сообщении о недоступности указывается ответ проверки:
  - `Response: status_code=XXX` для HTTP-ответа,
  - `Response: error=...` для сетевой/SSL/timeout ошибки.
- Если задан `checker_name`, уведомления о `DOWN` и `RECOVERED` получают префикс с именем сервера.
